Write a PL/SQL Block to increase the salary of employees by 10%
of existing salary, who are having salary less than average
salary of organization, whenever such salary updates takes place,
a record for same is maintained in the increment_salary table.
emp(emp_no, salary)
increment_salary(emp_no, salary)





CREATE TABLE emp (
  emp_no NUMBER PRIMARY KEY,
  emp_name VARCHAR2(100),
  salary NUMBER(10, 2)
);

CREATE TABLE increment_salary (
  log_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  emp_no NUMBER,
  salary NUMBER(10, 2), 
  increment_date DATE
);

INSERT INTO emp VALUES (1, 'Alice', 40000);
INSERT INTO emp VALUES (2, 'Bob', 60000);
INSERT INTO emp VALUES (3, 'Charlie', 80000);
-- Average salary is (40000+60000+80000)/3 = 60000
-- Only Alice (40000) should get a raise.
COMMIT;

SET SERVEROUTPUT ON;

DECLARE
  v_avg_salary  emp.salary%TYPE;
  v_new_salary  emp.salary%TYPE;

  CURSOR c_emp_below_avg IS
    SELECT emp_no, salary
    FROM emp
    WHERE salary < v_avg_salary
    FOR UPDATE OF salary; 

BEGIN
  SELECT AVG(salary)
  INTO v_avg_salary
  FROM emp;
  
  DBMS_OUTPUT.PUT_LINE('Average Salary: ' || TO_CHAR(v_avg_salary, '999,999.99'));

  FOR emp_rec IN c_emp_below_avg LOOP
    
    v_new_salary := emp_rec.salary * 1.10;
    
    UPDATE emp
    SET salary = v_new_salary
    WHERE emp_no = emp_rec.emp_no;
   
    INSERT INTO increment_salary (emp_no, salary, increment_date)
    VALUES (emp_rec.emp_no, v_new_salary, SYSDATE);
    
    DBMS_OUTPUT.PUT_LINE('Updated Employee: ' || emp_rec.emp_no
                         || ', Old Salary: ' || emp_rec.salary
                         || ', New Salary: ' || v_new_salary);
                         
  END LOOP;
  
  COMMIT;
  DBMS_OUTPUT.PUT_LINE('Salary update process complete.');

EXCEPTION
  WHEN OTHERS THEN
    DBMS_OUTPUT.PUT_LINE('An error occurred: ' || SQLERRM);
    ROLLBACK;
END;
/



CREATE TABLE emp (
  emp_no NUMBER PRIMARY KEY,
  salary NUMBER(10,2)
);

CREATE TABLE increment_salary (
  emp_no NUMBER,
  salary NUMBER(10,2)
);

INSERT INTO emp VALUES (101, 25000);
INSERT INTO emp VALUES (102, 40000);
INSERT INTO emp VALUES (103, 35000);
INSERT INTO emp VALUES (104, 60000);
INSERT INTO emp VALUES (105, 28000);
COMMIT;

SET SERVEROUTPUT ON;
DECLARE
  v_avg_salary emp.salary%TYPE;
BEGIN
  SELECT AVG(salary) INTO v_avg_salary FROM emp;
  DBMS_OUTPUT.PUT_LINE('Average Salary: ' || v_avg_salary);

 
  FOR rec IN (SELECT emp_no, salary FROM emp WHERE salary < v_avg_salary) LOOP
    
    UPDATE emp
    SET salary = salary + (salary * 0.10)
    WHERE emp_no = rec.emp_no;

    INSERT INTO increment_salary (emp_no, salary)
    VALUES (rec.emp_no, rec.salary + (rec.salary * 0.10));

    DBMS_OUTPUT.PUT_LINE('Salary updated for Emp No: ' || rec.emp_no);
  END LOOP;

  COMMIT;
  DBMS_OUTPUT.PUT_LINE('Salary increment process completed successfully.');

EXCEPTION
  WHEN NO_DATA_FOUND THEN
    DBMS_OUTPUT.PUT_LINE('No employee data found.');
  WHEN OTHERS THEN
    DBMS_OUTPUT.PUT_LINE('Unexpected Error: ' || SQLERRM);
END;
/

select * from increment_salary;
