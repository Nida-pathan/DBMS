
CREATE TABLE emp (
  emp_no NUMBER PRIMARY KEY,
  emp_name VARCHAR2(100),
  salary NUMBER(10, 2)
);

CREATE TABLE increment_salary (
  log_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  emp_no NUMBER,
  salary NUMBER(10, 2), 
  increment_date DATE
);

INSERT INTO emp VALUES (1, 'Alice', 40000);
INSERT INTO emp VALUES (2, 'Bob', 60000);
INSERT INTO emp VALUES (3, 'Charlie', 80000);
COMMIT;

SET SERVEROUTPUT ON;

DECLARE
  v_avg_salary  emp.salary%TYPE;
  v_new_salary  emp.salary%TYPE;

  CURSOR c_emp_below_avg IS
    SELECT emp_no, salary
    FROM emp
    WHERE salary < v_avg_salary
    FOR UPDATE OF salary; 

BEGIN
  SELECT AVG(salary)
  INTO v_avg_salary
  FROM emp;
  
  DBMS_OUTPUT.PUT_LINE('Average Salary: ' || TO_CHAR(v_avg_salary, '999,999.99'));

  FOR emp_rec IN c_emp_below_avg LOOP
    
    v_new_salary := emp_rec.salary * 1.10;
    
    UPDATE emp
    SET salary = v_new_salary
    WHERE emp_no = emp_rec.emp_no;
   
    INSERT INTO increment_salary (emp_no, salary, increment_date)
    VALUES (emp_rec.emp_no, v_new_salary, SYSDATE);
    
    DBMS_OUTPUT.PUT_LINE('Updated Employee: ' || emp_rec.emp_no
                         || ', Old Salary: ' || emp_rec.salary
                         || ', New Salary: ' || v_new_salary);
                         
  END LOOP;
  
  COMMIT;
  DBMS_OUTPUT.PUT_LINE('Salary update process complete.');

EXCEPTION
  WHEN OTHERS THEN
    DBMS_OUTPUT.PUT_LINE('An error occurred: ' || SQLERRM);
    ROLLBACK;
END;
/
